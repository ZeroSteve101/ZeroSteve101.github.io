<!doctype HTML>
<html>
    <head>
        <script src=".\player\jsmediatags.min.js"></script>
        <link rel="icon" href=".\player\favicon.png">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"> 
        <title>player</title>
        <style>
            * {
                font-family: 'Verdana', sans-serif;
            }
            body {
                background-color: black;
                color: white;
            }
            b {
                font-size: 20px;
            }
            .playerbox {
                background-color: #111111;
                height: 90vh;
                width: 70%;
                min-height: 200px;
                min-width: 512px;
                border: 1px solid grey;
                margin: auto;
                margin-top: 25px;
                border-radius: 1%;
            }
            .playerhalf {
                width: 50%;
                float: left;
            }
            .queuehalf {
                height: 80vh;
                width: 50%;
                float: left;
            }
            .queue {
                margin-left: 10px;
                margin-top: 15px;
                margin-right: 45px;
                max-height: 85%;
                overflow: scroll;
                border-radius: 1%;
                border: 1px solid grey;
            }
            .queueblob {
                border-radius: 5%;
                margin: auto;
                margin-top: 3px;
                margin-bottom: 2px;
                margin-left: 5px;
                margin-right: 5px;
                height: 50px;
                border: 1px solid grey;
                border-radius: 5px;
            }
            .smallcover {
                max-height: 100%;
                height: 50px;
                float: left;
                margin: auto;
                margin-right: 10px;
                border-radius: 5px;
            }
            .player {
                border-radius: 1%;
                margin: auto;
                background-color: #222222;
                margin-top: 30px;
                width: 80%;
                border-radius: 1%;
                border: 1px solid grey
            }
            .albumdiv {
				padding-top: 20px;
			}
            .albumcover {
                height: calc(50vh - 30px);
                display: block; 
                margin: auto;
                border: 1px solid grey; 
                border-radius: 2%;
            }
            .controls {
                margin: auto;
                margin-bottom: 15px;
                text-align: center;
            }
            .seek {
				width: 85%;
			}
            button {
                background-color: darkblue;
                border: 1px solid white;
                color: white;
                justify-content: center;
                vertical-align: bottom;
                align-items: center;
            }
			.buttonlarge {
				height: 40px;
				width: 40px;
				font-size: 20px;
                border-radius: 5px;
			}
            label {
                padding-left: 5px;
                padding-right: 5px;
                background-color: darkblue;
                border: 1px solid white;
                color: white;
                justify-content: center;
                align-items: center;
            }
            .buttontext {
                height: 20px;
                border-radius: 2px;
                width: auto;
                margin-left: 10px;
                margin-top: 15px;
                font-size: 15px;
            }
            button:hover {
                background-color: blue;
            }
            button:active {
                background-color: #5b5bff;
            }
            label:hover {
                background-color: blue;
            }
            label:active {
                background-color: #5b5bff;
            }
            .info {
                text-align: center;
                margin-top: 10px;
                margin-bottom: 15px;
                padding-left: 15px;
                padding-right: 15px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: clip;
            }
            .playback {
                font-family: monospace;
            }
            input[type="file"] {
                display: none;
            }
        </style>
    </head>

    <body>
        <div class="playerbox">
            <div class="playerhalf">
                <div class="player">
                    <div class="albumdiv">
                        <img class="albumcover" id="albumcover" src=".\player\icon.png">
                    </div>
                    <div class="info">
                        <b id="playingTitle">TITLE</b><br>
                        <span id="playingArtist" style="font-size: 12px;">ARTIST</span> - <span id="playingAlbum" style="font-size: 12px;">ALBUM</span>
                    </div>
                    <div class="controls">
                        <button class="buttonlarge" id="back" type="button">«</button>
                        <button class="buttonlarge" id="paused" type="button">▶</button>
                        <button class="buttonlarge" id="forward" type="button">»</button><br>
                        <input class="seek" id="playerSeek" type="range" min="0" max="100" value="0"><br>
                        <div class="playback">
                            <span id="currentTime">0:00</span> / <span id="minusTime">-0:00</span> / <span id="totalTime">0:00</span>
                        </div>
                        <audio id="currentAudio"></audio>
                    </div>
                </div>
            </div>
            <div class="queuehalf">
                <div class="queuecontainer">
                    <button class="buttontext" id="shuffle" type="button" onclick="shufflePlaylist()">Shuffle</button>
                    <label class="buttontext">
                        Load Folder
                        <input id="loadFolders" type="file" webkitdirectory directory multiple>
                    </label>
                    <label class="buttontext">
                        Load Files
                        <input id="loadFiles" type="file" multiple accept="audio/*">
                    </label>
                    <script>
                        var jsmediatags = window.jsmediatags
                        //player
                        var playerState = 'paused'
                        
                        var currentAudio = document.getElementById('currentAudio'),
                            pause = document.getElementById('paused'),
                            next = document.getElementById('forward'),
                            back = document.getElementById('back'),
                            seek = document.getElementById('playerSeek'),
                            currentTime = document.getElementById('currentTime'),
                            totalTime = document.getElementById('totalTime'),
                            minusTime = document.getElementById('minusTime')
                        
                        const album = document.getElementById('playingAlbum')
                        const artist = document.getElementById('playingArtist')
                        const title = document.getElementById('playingTitle')
                        const cover = document.getElementById('albumcover')

                        var fileList = []
                        var playlistIndex = 0

                        pause.onclick = function () {
                            if (currentAudio.readyState >= 3) {
                                if (playerState == 'paused') {
                                    currentAudio.play()
                                } else {
                                    currentAudio.pause()
                                }
                            } else {
                                pause.textContent = "▶"
                                playerState = 'paused'
                            }
                        }

                        next.onclick = function () {
                            if (playlistIndex < fileList.length - 1) {
                                playlistIndex += 1
                                setMusic(fileList[playlistIndex])
                            } else {
                                playlistIndex = 0
                                setMusic(fileList[playlistIndex])
                            }
                        }

                        back.onclick = function () {
                            if (playlistIndex > 0) {
                                playlistIndex -= 1
                                setMusic(fileList[playlistIndex])
                            } else {
                                playlistIndex = fileList.length
                                setMusic(fileList[playlistIndex])
                            }
                        }

                        seek.addEventListener('input', () => {
                            currentTime.textContent = calculateTime(seek.value)
                            minusTime.textContent = `-${calculateTime(seek.max - seek.value)}`
                        })

                        seek.addEventListener('change', () => {
                            currentAudio.currentTime = seek.value
                        })

                        currentAudio.addEventListener('timeupdate', () => {
                            seek.value = Math.floor(currentAudio.currentTime)
                            currentTime.textContent = calculateTime(currentAudio.currentTime)
                            minusTime.textContent = `-${calculateTime(currentAudio.duration - currentAudio.currentTime)}`
                        })

                        currentAudio.addEventListener('loadedmetadata', () => {
                            seek.max = Math.floor(currentAudio.duration)
                            totalTime.textContent = calculateTime(currentAudio.duration)
                        });

                        currentAudio.addEventListener('play', () => {
                            pause.textContent = "❙❙"
                            playerState = 'play'
                        })

                        currentAudio.addEventListener('pause', () => {
                            pause.textContent = "▶"
                            playerState = 'paused'
                        })

                        currentAudio.addEventListener("ended", function(){
                            currentAudio.currentTime = 0;
                            if (playlistIndex < fileList.length) {
                                playlistIndex += 1
                            } else {
                                playlistIndex = 0
                            }
                            setMusic(fileList[playlistIndex])
                            currentAudio.play()
                        });

                        const calculateTime = (secs) => {
                            const minutes = Math.floor(secs / 60);
                            const seconds = Math.floor(secs % 60);
                            const returnedSeconds = seconds < 10 ? `0${seconds}` : `${seconds}`;
                            return `${minutes}:${returnedSeconds}`;
                        }

                        function setMusic(musicFile) {
                            currentAudio.pause()
                            var musicURL = URL.createObjectURL(musicFile)
                            currentAudio.src = musicURL;

                            jsmediatags.read(musicFile, {
                                onSuccess: (tag) => {
                                    const tags = tag.tags
                                    title.textContent = tags.title || musicFile.name
                                    album.textContent = tags.album || ""
                                    artist.textContent = tags.artist || ""

                                    var picture = tags.picture

                                    if (picture && picture != null) {
                                        var base64String = "";
                                        for (var i = 0; i < picture.data.length; i++) {
                                            base64String += String.fromCharCode(picture.data[i]);
                                        }
                                        var imageUri = "data:" + picture.format + ";base64," + window.btoa(base64String);
                                        cover.src = imageUri
                                    } else {
                                        cover.src = ".\\player\\icon.png"
                                    }
                                    console.log(cover.src)
                                },
                                onError: function() {
                                    title.textContent = musicFile.name

                                } 
                            })

                            seek.value = 0
                            if (playerState == 'paused') {
                                playerState = 'paused'
                                pause.textContent = "▶"
                            } else {
                                currentAudio.play()
                            }
                        }

                        document.getElementById('loadFolders').addEventListener('change', function(e) {
                            if (e.target.files) {
                                playlistIndex = 0
                                fileList = Array.from(e.target.files)
                                setMusic(fileList[playlistIndex])
                            }
                        })

                        document.getElementById('loadFiles').addEventListener('change', function(e) {
                            if (e.target.files) {
                                playlistIndex = 0
                                fileList = Array.from(e.target.files)
                                setMusic(fileList[playlistIndex])
                            }
                        })

                        function shufflePlaylist() {
                            console.log(fileList)
                            fileList = shuffleArray(fileList)
                            console.log(fileList)
                            playlistIndex = 0
                            setMusic(fileList[playlistIndex])
                        }

                        function shuffleArray(array) {
                            for (let i = array.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [array[i], array[j]] = [array[j], array[i]];
                            }
                            return array;
                        }
                    </script>
                </div>
                <div class="queue">
                    <div class="queueblob">
                        <img class="smallcover" src=".\player\icon.png">
                        <b style="font-size: 20px;">TITLE</b><br>
                        <p5 style="font-size: 12px;">ARTIST - ALBUM</p5>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
